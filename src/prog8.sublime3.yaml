%YAML 1.2
---
name: prog8
scope: source.prog8
file_extensions: [ p8, prog8 ]

contexts:
  main:
    - include: comment
    - include: meta
    - match: '(^\s*\w+\s*)(\{)'
      captures:
        0: entity.name.section.prog8
        1: punctuation.prog8
      push: 
        - match: '(\})'
          pop: true
          captures:
            0: punctuation.prog8
        - include: general
        - match: '(.)'
          captures:
            0: text.prog8
    - match: '(^\s*\w+\s*)(\$[\da-fA-F]+\s*)(\{)'
      captures:
        0: entity.name.section.prog8
        1: constant.numeric.prog8
        2: punctuation.prog8
      push: 
        - match: '(\})'
          pop: true
          captures:
            0: punctuation.prog8
        - include: general
        - match: '(.)'
          captures:
            0: text.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  general:
    - match: '(^\s*)(\%asm)(\s*{{)'
      captures:
        0: punctuation.prog8
        1: keyword.control.directive.prog8
        2: punctuation.prog8
      push: 
        - match: '(}})'
          pop: true
          captures:
            0: punctuation.prog8
        - include: assembler
        - include: comment
        - include: numeric
        - include: label
        - include: section
        - include: variable
        - match: '(.)'
          captures:
            0: text.prog8
    - match: '(\{)'
      captures:
        0: punctuation.prog8
      push: 
        - match: '(\})'
          pop: true
          captures:
            0: punctuation.prog8
        - include: general
        - match: '(.)'
          captures:
            0: text.prog8
    - match: '(\")'
      captures:
        0: punctuation.prog8
      push: 
        - match: '(\")'
          pop: true
          captures:
            0: punctuation.prog8
        - match: '(.)'
          captures:
            0: text.prog8
    - match: '(\()'
      captures:
        0: punctuation.prog8
      push: 
        - match: '(\))'
          pop: true
          captures:
            0: punctuation.prog8
        - include: general
        - match: '(.)'
          captures:
            0: text.prog8
    - include: comment
    - include: numeric
    - include: keywords
    - include: storage
    - include: constant
    - include: support
    - include: label
    - include: meta
    - match: '(\w+)(\s*)(\()'
      captures:
        0: entity.name.function.prog8
        1: punctuation.prog8
        2: punctuation.prog8
      push: 
        - match: '(\))'
          pop: true
          captures:
            0: punctuation.prog8
        - include: general
        - match: '(.)'
          captures:
            0: text.prog8
    - include: section
    - include: variable
    - match: '(.)'
      captures:
        0: text.prog8
  section:
    - match: '(\b\w+\.)'
      captures:
        0: entity.name.section.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  label:
    - match: '(^\s*\w+\:)'
      captures:
        0: entity.name.label.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  comment:
    - match: '(\;.+)'
      captures:
        0: comment.line.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  variable:
    - match: '(\b\w+\b)'
      captures:
        0: variable.other.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  keywords:
    - match: '(\b(sub|if|if_cs|if_cc|if_eq|if_ne|if_pl|if_mi|if_vs|if_vc|if_z|if_nz|if_pos|if_neg|for|in|to|step|do|while|until|repeat|else|when|return|break|as|goto|asmsub|clobbers)\b)'
      captures:
        0: keyword.control.prog8
    - match: '(\b(and|or)\b)'
      captures:
        0: keyword.operator.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  storage:
    - match: '(\b(void|ubyte|byte|word|uword|float|str)\b)'
      captures:
        0: storage.type.prog8
    - match: '(\b(const)\b)'
      captures:
        0: storage.modifier.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  constant:
    - match: '(true|false)'
      captures:
        0: constant.language.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  support:
    - match: '(\b(abs|atan|ceil|cos|cos8u|cos8|cos16u|cos16|deg|floor|ln|log2|rad|round|sin|sgn|sin8u|sin8|sin16u|sin16|sqrt16|sqrt|tan|any|all|len|max|min|reverse|sum|sort|memcopy|memset|memsetw|leftstr|rightstr|strlen|strcmp|substr|exit|lsb|msb|mkword|rnd|rndw|rndf|rol|rol2|ror|ror2|rsave|rrestore|read_flags|sizeof|set_carry|clear_carry|set_irqd|clear_irqd|swap)\b)'
      captures:
        0: support.function.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  meta:
    - match: '(^\s*)(%)([a-zA-Z]+)'
      captures:
        0: punctuation.prog8
        1: meta.directive.prog8
        2: keyword.control.directive.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  assembler:
    - match: '(\b(adc|and|asl|bcc|bcs|beq|bit|bmi|bne|bpl|brk|bvc|bvs|clc|cld|cli|clv|cmp|cpx|cpy|dec|dex|dey|eor|inc|inx|iny|jmp|jsr|lda|ldx|ldy|lsr|nop|ora|pha|php|pla|plp|rol|ror|rti|rts|sbc|sec|sed|sei|sta|stx|sty|tax|tay|tsx|txa|txs|tya|bra|brl|cop|jml|jsl|mvn|mvp|pea|pei|per|phb|phd|phk|phx|phy|plb|pld|plx|ply|rep|rtl|sep|stp|stz|tcd|tcs|tdc|trb|tsb|tsc|txy|tyx|wai|wdm|xba|xce|ADC|AND|ASL|BCC|BCS|BEQ|BIT|BMI|BNE|BPL|BRK|BVC|BVS|CLC|CLD|CLI|CLV|CMP|CPX|CPY|DEC|DEX|DEY|EOR|INC|INX|INY|JMP|JSR|LDA|LDX|LDY|LSR|NOP|ORA|PHA|PHP|PLA|PLP|ROL|ROR|RTI|RTS|SBC|SEC|SED|SEI|STA|STX|STY|TAX|TAY|TSX|TXA|TXS|TYA|BRA|BRL|COP|JML|JSL|MVN|MVP|PEA|PEI|PER|PHB|PHD|PHK|PHX|PHY|PLB|PLD|PLX|PLY|REP|RTL|SEP|STP|STZ|TCD|TCS|TDC|TRB|TSB|TSC|TXY|TYX|WAI|WDM|XBA|XCE)\b)'
      captures:
        0: support.function.prog8
    - match: '(.)'
      captures:
        0: text.prog8
  numeric:
    - match: '(\b\d+)'
      captures:
        0: constant.numeric.prog8
    - match: '(\-?\d+\.\d+e?\d+)'
      captures:
        0: constant.numeric.prog8
    - match: '(\$[\da-fA-F]+)'
      captures:
        0: constant.numeric.prog8
    - match: '(\%[0-1]+)'
      captures:
        0: constant.numeric.prog8
    - match: '(\''.\'')'
      captures:
        0: constant.numeric.prog8
    - match: '(.)'
      captures:
        0: text.prog8
